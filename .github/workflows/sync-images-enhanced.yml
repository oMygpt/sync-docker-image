name: Enhanced Docker Image Sync with Crane

on:
  push:
    paths:
      - 'upload/images.md'
      - 'upload/batch_sync.json'
  workflow_dispatch:
    inputs:
      images:
        description: 'é•œåƒåˆ—è¡¨ (æ¯è¡Œä¸€ä¸ªï¼Œæˆ–JSONæ ¼å¼)'
        required: false
        type: string
      dry_run:
        description: 'å¹²è¿è¡Œæ¨¡å¼'
        required: false
        type: boolean
        default: false
      max_parallel:
        description: 'æœ€å¤§å¹¶å‘æ•°'
        required: false
        type: number
        default: 3
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå¿½ç•¥å·²å¤„ç†æ ‡è®°ï¼‰'
        required: false
        type: boolean
        default: false

env:
  MAX_RETRIES: 3
  RETRY_DELAY: 10
  LOG_LEVEL: INFO

jobs:
  # é¢„æ£€æŸ¥ä½œä¸š
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      images-count: ${{ steps.parse.outputs.images-count }}
      config-valid: ${{ steps.validate.outputs.config-valid }}
      images-matrix: ${{ steps.parse.outputs.images-matrix }}
      dockerhub-auth: ${{ steps.validate.outputs.dockerhub-auth }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate configuration
        id: validate
        run: |
          echo "ğŸ” éªŒè¯é…ç½®..."
          
          # æ£€æŸ¥å¿…éœ€çš„secrets (é˜¿é‡Œäº‘)
          required_secrets=(
            "ALIYUN_USERNAME"
            "ALIYUN_PASSWORD"
          )
          
          # æ£€æŸ¥å¯é€‰çš„secrets (DockerHub)
          optional_secrets=(
            "DOCKERHUB_USERNAME"
            "DOCKERHUB_TOKEN"
          )
          
          missing_secrets=()
          for secret in "${required_secrets[@]}"; do
            if [[ -z "${!secret:-}" ]]; then
              missing_secrets+=("$secret")
            fi
          done
          
          if [[ ${#missing_secrets[@]} -gt 0 ]]; then
            echo "âŒ ç¼ºå°‘å¿…éœ€çš„é˜¿é‡Œäº‘secrets: ${missing_secrets[*]}"
            echo "config-valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # æ£€æŸ¥DockerHubå‡­è¯ï¼ˆå¯é€‰ï¼‰
          if [[ -n "$DOCKERHUB_USERNAME" && -n "$DOCKERHUB_TOKEN" ]]; then
            echo "âœ… æ£€æµ‹åˆ°DockerHubå‡­è¯ï¼Œå°†ä½¿ç”¨è®¤è¯æ‹‰å–"
            echo "dockerhub-auth=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªé…ç½®DockerHubå‡­è¯ï¼Œå°†ä½¿ç”¨åŒ¿åæ‹‰å–å…¬å¼€é•œåƒ"
            echo "dockerhub-auth=false" >> $GITHUB_OUTPUT
          fi
          
          echo "âœ… é…ç½®éªŒè¯é€šè¿‡"
          echo "config-valid=true" >> $GITHUB_OUTPUT
        env:
          ALIYUN_USERNAME: ${{ secrets.ALIYUN_USERNAME }}
          ALIYUN_PASSWORD: ${{ secrets.ALIYUN_PASSWORD }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Parse image list
        id: parse
        run: |
          echo "ğŸ“‹ è§£æé•œåƒåˆ—è¡¨..."
          
          images_file="upload/images.md"
          batch_file="upload/batch_sync.json"
          images_array=()
          
          # å¤„ç†æ‰‹åŠ¨è¾“å…¥çš„é•œåƒ
          if [[ -n "${{ github.event.inputs.images }}" ]]; then
            echo "å¤„ç†æ‰‹åŠ¨è¾“å…¥çš„é•œåƒåˆ—è¡¨"
            while IFS= read -r line; do
              line=$(echo "$line" | xargs)  # å»é™¤å‰åç©ºæ ¼
              [[ -n "$line" && "${line:0:1}" != "#" ]] && images_array+=("$line")
            done <<< "${{ github.event.inputs.images }}"
          fi
          
          # å¤„ç†æ‰¹é‡åŒæ­¥JSONæ–‡ä»¶
          if [[ -f "$batch_file" ]]; then
            echo "å¤„ç†æ‰¹é‡åŒæ­¥JSONæ–‡ä»¶"
            while IFS= read -r image; do
              [[ -n "$image" ]] && images_array+=("$image")
            done < <(jq -r '.images[]?' "$batch_file" 2>/dev/null || true)
          fi
          
          # å¤„ç†æ ‡å‡†é•œåƒåˆ—è¡¨æ–‡ä»¶
          if [[ -f "$images_file" ]]; then
            echo "å¤„ç†æ ‡å‡†é•œåƒåˆ—è¡¨æ–‡ä»¶"
            while IFS= read -r line || [[ -n "$line" ]]; do
              line=$(echo "$line" | tr -d '\r' | xargs)
              [[ -n "$line" && "${line:0:1}" != "#" ]] && images_array+=("$line")
            done < "$images_file"
          fi
          
          # å»é‡å¹¶éªŒè¯
          declare -A unique_images
          valid_images=()
          
          for image in "${images_array[@]}"; do
            # åŸºæœ¬æ ¼å¼éªŒè¯
            if [[ "$image" =~ ^[a-zA-Z0-9._-]+(/[a-zA-Z0-9._-]+)*(:([a-zA-Z0-9._-]+))?$ ]]; then
              # æ·»åŠ é»˜è®¤æ ‡ç­¾
              if [[ ! "$image" =~ ":" ]]; then
                image="${image}:latest"
              fi
              
              # å»é‡
              if [[ -z "${unique_images[$image]:-}" ]]; then
                unique_images["$image"]=1
                valid_images+=("$image")
              fi
            else
              echo "âš ï¸ è·³è¿‡æ— æ•ˆé•œåƒæ ¼å¼: $image"
            fi
          done
          
          images_count=${#valid_images[@]}
          echo "ğŸ“Š æ‰¾åˆ° $images_count ä¸ªæœ‰æ•ˆé•œåƒ"
          
          if [[ $images_count -eq 0 ]]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é•œåƒè¿›è¡ŒåŒæ­¥"
            exit 1
          fi
          
          # åˆ›å»ºçŸ©é˜µ
          matrix_json=$(printf '%s\n' "${valid_images[@]}" | jq -R . | jq -s .)
          
          echo "images-count=$images_count" >> $GITHUB_OUTPUT
          echo "images-matrix=$matrix_json" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºå°†è¦å¤„ç†çš„é•œåƒ
          echo "ğŸ“‹ å°†è¦åŒæ­¥çš„é•œåƒ:"
          printf '  - %s\n' "${valid_images[@]}"

  # ä¸»åŒæ­¥ä½œä¸š
  sync-images:
    needs: pre-check
    if: needs.pre-check.outputs.config-valid == 'true' && needs.pre-check.outputs.images-count > 0
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: ${{ fromJson(github.event.inputs.max_parallel || '3') }}
      matrix:
        image: ${{ fromJson(needs.pre-check.outputs.images-matrix) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up crane
        uses: imjasonh/setup-crane@v0.1
        
      - name: Install dependencies
        run: |
          echo "ğŸ”§ å®‰è£…ä¾èµ–å·¥å…·..."
          
          # å®‰è£…jqï¼ˆç”¨äºJSONå¤„ç†ï¼‰
          sudo apt-get update && sudo apt-get install -y jq
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p temp done logs
          
          # éªŒè¯craneå®‰è£…
          crane version

      - name: Configure authentication
        run: |
          echo "ğŸ” é…ç½®è®¤è¯ä¿¡æ¯..."
          
          # ç™»å½•é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡ (æ­å·åŒºåŸŸ)
          echo "Logging in to Aliyun Container Registry (Hangzhou)..."
          if ! crane auth login -u "${{ secrets.ALIYUN_USERNAME }}" -p "${{ secrets.ALIYUN_PASSWORD }}" registry.cn-hangzhou.aliyuncs.com; then
            echo "âŒ é˜¿é‡Œäº‘è®¤è¯å¤±è´¥"
            echo "è¯·æ£€æŸ¥ ALIYUN_USERNAME å’Œ ALIYUN_PASSWORD secrets"
            echo "ç”¨æˆ·ååº”ä¸º: swufelab"
            echo "ä»“åº“åœ°å€: registry.cn-hangzhou.aliyuncs.com"
            exit 1
          fi
          echo "âœ… é˜¿é‡Œäº‘è®¤è¯æˆåŠŸ (registry.cn-hangzhou.aliyuncs.com)"
          
          # å¯é€‰ï¼šç™»å½•DockerHubï¼ˆå¦‚æœé…ç½®äº†å‡­è¯ï¼‰
          if [[ "${{ needs.pre-check.outputs.dockerhub-auth }}" == "true" ]]; then
            echo "Logging in to Docker Hub..."
            if ! crane auth login -u "${{ secrets.DOCKERHUB_USERNAME }}" -p "${{ secrets.DOCKERHUB_TOKEN }}" docker.io; then
              echo "âš ï¸ DockerHubè®¤è¯å¤±è´¥ï¼Œå°†ä½¿ç”¨åŒ¿åæ‹‰å–"
            else
              echo "âœ… DockerHubè®¤è¯æˆåŠŸ"
            fi
          else
            echo "â„¹ï¸ è·³è¿‡DockerHubè®¤è¯ï¼Œå°†ä½¿ç”¨åŒ¿åæ‹‰å–"
          fi

      - name: Process single image
        id: sync
        run: |
          set -euo pipefail
          
          # è®¾ç½®å˜é‡
          SOURCE_IMAGE="${{ matrix.image }}"
          NAMESPACE="dslab"  # å›ºå®šå‘½åç©ºé—´
          REGISTRY="registry.cn-hangzhou.aliyuncs.com"  # å›ºå®šæ­å·åŒºåŸŸ
          REPO_NAME="vllm"  # å›ºå®šä»“åº“å
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          FORCE_SYNC="${{ github.event.inputs.force_sync || 'false' }}"
          
          # æ—¥å¿—æ–‡ä»¶
          LOG_FILE="logs/sync_${SOURCE_IMAGE//[\/:]/_}_$(date +%Y%m%d_%H%M%S).log"
          
          # æ—¥å¿—å‡½æ•°
          log() {
            local level="$1"
            local message="$2"
            local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
            echo "[$level] $timestamp - $message" | tee -a "$LOG_FILE"
          }
          
          # è¿›åº¦æŠ¥å‘Šå‡½æ•°
          report_progress() {
            local step="$1"
            local status="$2"
            local message="$3"
            echo "::group::ğŸ“Š [$step] $status"
            echo "$message"
            echo "::endgroup::"
          }
          
          log "INFO" "å¼€å§‹å¤„ç†é•œåƒ: $SOURCE_IMAGE"
          report_progress "å¼€å§‹" "ğŸš€" "å¼€å§‹åŒæ­¥é•œåƒ $SOURCE_IMAGE"
          
          # è§£æé•œåƒä¿¡æ¯
          image_name=$(echo "$SOURCE_IMAGE" | cut -d':' -f1)
          image_tag=$(echo "$SOURCE_IMAGE" | grep ':' > /dev/null && echo "$SOURCE_IMAGE" | cut -d':' -f2 || echo "latest")
          repo_name=$(echo "$image_name" | rev | cut -d'/' -f1 | rev)
          
          # æ„é€ ç›®æ ‡é•œåƒè·¯å¾„ - ä½¿ç”¨vllmä½œä¸ºä»“åº“åï¼ŒåŸé•œåƒåä½œä¸ºæ ‡ç­¾å‰ç¼€
          TARGET_IMAGE="${REGISTRY}/${NAMESPACE}/${REPO_NAME}:${repo_name}-${image_tag}"
          
          log "INFO" "æºé•œåƒ: $SOURCE_IMAGE"
          log "INFO" "ç›®æ ‡é•œåƒ: $TARGET_IMAGE"
          
          # æ£€æŸ¥æ˜¯å¦å·²å¤„ç†ï¼ˆé™¤éå¼ºåˆ¶åŒæ­¥ï¼‰
          done_marker="done/${SOURCE_IMAGE//[\/:]/_}.txt"
          if [[ "$FORCE_SYNC" != "true" && -f "$done_marker" ]]; then
            log "INFO" "é•œåƒå·²å¤„ç†ï¼Œè·³è¿‡: $SOURCE_IMAGE"
            report_progress "è·³è¿‡" "â­ï¸" "é•œåƒ $SOURCE_IMAGE å·²å¤„ç†ï¼Œè·³è¿‡åŒæ­¥"
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "message=é•œåƒå·²å¤„ç†" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # å¹²è¿è¡Œæ¨¡å¼
          if [[ "$DRY_RUN" == "true" ]]; then
            log "INFO" "[DRY RUN] æ¨¡æ‹ŸåŒæ­¥: $SOURCE_IMAGE -> $TARGET_IMAGE"
            report_progress "å¹²è¿è¡Œ" "ğŸ§ª" "æ¨¡æ‹ŸåŒæ­¥ $SOURCE_IMAGE -> $TARGET_IMAGE"
            echo "status=dry-run" >> $GITHUB_OUTPUT
            echo "message=å¹²è¿è¡Œæ¨¡å¼" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ™ºèƒ½é•œåƒæ‹‰å–å‡½æ•°
          smart_pull_image() {
            local source_image="$1"
            local max_attempts=3
            local attempt=1
            
            while [[ $attempt -le $max_attempts ]]; do
              log "INFO" "å°è¯•æ‹‰å–é•œåƒ $source_image (ç¬¬ $attempt/$max_attempts æ¬¡)"
              
              # ä½¿ç”¨crane lsæ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
              if crane ls "$(echo $source_image | cut -d':' -f1)" | grep -q "$(echo $source_image | cut -d':' -f2)"; then
                log "INFO" "é•œåƒ $source_image å­˜åœ¨ï¼Œå¼€å§‹æ‹‰å–"
                return 0
              else
                log "WARN" "é•œåƒ $source_image ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®"
                if [[ $attempt -lt $max_attempts ]]; then
                  log "INFO" "ç­‰å¾… $RETRY_DELAY ç§’åé‡è¯•..."
                  sleep $RETRY_DELAY
                fi
              fi
              
              ((attempt++))
            done
            
            log "ERROR" "æ— æ³•æ‹‰å–é•œåƒ $source_image"
            return 1
          }
          
          # é‡è¯•å‡½æ•°
          retry_command() {
            local max_attempts="$1"
            local delay="$2"
            local description="$3"
            shift 3
            local command=("$@")
            
            local attempt=1
            while [[ $attempt -le $max_attempts ]]; do
              log "INFO" "$description (å°è¯• $attempt/$max_attempts)"
              
              if "${command[@]}"; then
                log "INFO" "$description æˆåŠŸ"
                return 0
              else
                local exit_code=$?
                if [[ $attempt -lt $max_attempts ]]; then
                  log "WARN" "$description å¤±è´¥ï¼Œ${delay}ç§’åé‡è¯•..."
                  sleep "$delay"
                else
                  log "ERROR" "$description åœ¨ $max_attempts æ¬¡å°è¯•åå¤±è´¥"
                  return $exit_code
                fi
              fi
              
              ((attempt++))
            done
          }
          
          # æ‰§è¡ŒåŒæ­¥æ­¥éª¤
          sync_status="SUCCESS"
          error_message=""
          
          # æ­¥éª¤1: éªŒè¯æºé•œåƒå­˜åœ¨
          report_progress "éªŒè¯é•œåƒ" "ğŸ”" "éªŒè¯æºé•œåƒ $SOURCE_IMAGE æ˜¯å¦å­˜åœ¨"
          if ! smart_pull_image "$SOURCE_IMAGE"; then
            sync_status="FAILED"
            error_message="æºé•œåƒä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®"
          fi
          
          # æ­¥éª¤2: ä½¿ç”¨craneç›´æ¥å¤åˆ¶é•œåƒ
          if [[ "$sync_status" == "SUCCESS" ]]; then
            report_progress "åŒæ­¥é•œåƒ" "ğŸš€" "ä½¿ç”¨craneå¤åˆ¶ $SOURCE_IMAGE -> $TARGET_IMAGE"
            
            # æ–¹æ³•1: å°è¯•ç›´æ¥å¤åˆ¶
            log "INFO" "å°è¯•ç›´æ¥å¤åˆ¶é•œåƒ..."
            if crane copy "$SOURCE_IMAGE" "$TARGET_IMAGE" 2>&1 | tee copy_log.txt; then
              log "INFO" "âœ… ç›´æ¥å¤åˆ¶æˆåŠŸ"
            else
              log "WARN" "ç›´æ¥å¤åˆ¶å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•..."
              
              # æ–¹æ³•2: é€šè¿‡æœ¬åœ°ç¼“å­˜æ–¹å¼
              log "INFO" "ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ–¹å¼..."
              if crane pull "$SOURCE_IMAGE" /tmp/image.tar; then
                log "INFO" "é•œåƒå·²æ‹‰å–åˆ°æœ¬åœ°ç¼“å­˜"
                if crane push /tmp/image.tar "$TARGET_IMAGE"; then
                  log "INFO" "âœ… é€šè¿‡æœ¬åœ°ç¼“å­˜åŒæ­¥æˆåŠŸ"
                  rm -f /tmp/image.tar
                else
                  log "ERROR" "æœ¬åœ°ç¼“å­˜æ¨é€å¤±è´¥"
                  sync_status="FAILED"
                  error_message="é•œåƒåŒæ­¥å¤±è´¥"
                  cat copy_log.txt || true
                fi
              else
                log "ERROR" "æ— æ³•æ‹‰å–é•œåƒåˆ°æœ¬åœ°ç¼“å­˜"
                sync_status="FAILED"
                error_message="é•œåƒæ‹‰å–å¤±è´¥"
              fi
            fi
          fi
          
          # è®°å½•ç»“æœ
          if [[ "$sync_status" == "SUCCESS" ]]; then
            touch "$done_marker"
            log "INFO" "é•œåƒåŒæ­¥æˆåŠŸ: $SOURCE_IMAGE -> $TARGET_IMAGE"
            report_progress "å®Œæˆ" "âœ…" "é•œåƒ $SOURCE_IMAGE åŒæ­¥æˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=åŒæ­¥æˆåŠŸ" >> $GITHUB_OUTPUT
            echo "target_image=$TARGET_IMAGE" >> $GITHUB_OUTPUT
          else
            log "ERROR" "é•œåƒåŒæ­¥å¤±è´¥: $SOURCE_IMAGE - $error_message"
            report_progress "å¤±è´¥" "âŒ" "é•œåƒ $SOURCE_IMAGE åŒæ­¥å¤±è´¥: $error_message"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "message=$error_message" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs-${{ matrix.image }}
          path: logs/
          retention-days: 7

  # åå¤„ç†ä½œä¸š
  post-process:
    needs: [pre-check, sync-images]
    if: always() && needs.pre-check.outputs.config-valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all logs
        uses: actions/download-artifact@v4
        with:
          path: all-logs/
          pattern: sync-logs-*

      - name: Generate sync report
        run: |
          echo "ğŸ“Š ç”ŸæˆåŒæ­¥æŠ¥å‘Š..."
          
          # åˆ›å»ºæŠ¥å‘Šæ–‡ä»¶
          report_file="sync_report_$(date +%Y%m%d_%H%M%S).md"
          
          cat > "$report_file" << EOF
          # Dockeré•œåƒåŒæ­¥æŠ¥å‘Š
          
          **åŒæ­¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
          **è¿è¡ŒID**: ${{ github.run_id }}
          **æäº¤**: ${{ github.sha }}
          
          ## åŒæ­¥ç»“æœ
          
          | é•œåƒ | çŠ¶æ€ | ç›®æ ‡é•œåƒ | å¤‡æ³¨ |
          |------|------|----------|------|
          EOF
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šæŠ¥å‘Šç”Ÿæˆé€»è¾‘
          # åˆ†ææ—¥å¿—æ–‡ä»¶ï¼Œç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡ç­‰
          
          echo "ğŸ“„ æŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"

      - name: Update image mapping
        run: |
          echo "ğŸ—ºï¸ æ›´æ–°é•œåƒæ˜ å°„è¡¨..."
          
          # åˆå§‹åŒ–æ˜ å°„æ–‡ä»¶
          if [[ ! -f "image_list.md" ]]; then
            cat > "image_list.md" << EOF
          # Docker Image Mapping
          
          | DockerHub Image | Aliyun Mirror | åŒæ­¥æ—¶é—´ | çŠ¶æ€ |
          |-----------------|---------------|----------|------|
          EOF
          fi
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´æ–°æ˜ å°„è¡¨çš„é€»è¾‘
          # åŸºäºåŒæ­¥ç»“æœæ›´æ–°æ˜ å°„å…³ç³»
          
          echo "âœ… æ˜ å°„è¡¨æ›´æ–°å®Œæˆ"

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ·»åŠ å˜æ›´
          git add done/ image_list.md sync_report_*.md || true
          
          # æäº¤å˜æ›´
          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°: é•œåƒåŒæ­¥ç»“æœ ($(date '+%Y-%m-%d %H:%M:%S'))"
            git push
            echo "âœ… å˜æ›´å·²æäº¤å¹¶æ¨é€"
          fi

      - name: Create summary
        run: |
          echo "ğŸ“‹ åˆ›å»ºå·¥ä½œæµæ‘˜è¦..."
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ğŸ³ Dockeré•œåƒåŒæ­¥å®Œæˆ
          
          ## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
          - **å¤„ç†é•œåƒæ•°é‡**: ${{ needs.pre-check.outputs.images-count }}
          - **åŒæ­¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          - **è¿è¡Œæ¨¡å¼**: ${{ github.event.inputs.dry_run == 'true' && 'ğŸ§ª å¹²è¿è¡Œ' || 'ğŸš€ å®é™…åŒæ­¥' }}
          
          ## ğŸ”— ç›¸å…³é“¾æ¥
          - [æŸ¥çœ‹è¯¦ç»†æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [é•œåƒæ˜ å°„è¡¨](./image_list.md)
          
          ## ğŸ“ ä½¿ç”¨è¯´æ˜
          
          ### æ‰‹åŠ¨è§¦å‘åŒæ­¥
          \`\`\`bash
          # ä½¿ç”¨å¢å¼ºç‰ˆè„šæœ¬
          ./transfer_enhanced.sh -s nginx:latest -d registry.cn-hangzhou.aliyuncs.com/namespace/nginx:latest -v
          
          # å¹²è¿è¡Œæ¨¡å¼
          ./transfer_enhanced.sh -s redis:alpine -d registry.cn-hangzhou.aliyuncs.com/namespace/redis:alpine --dry-run
          \`\`\`
          
          ### æ‰¹é‡åŒæ­¥
          1. ç¼–è¾‘ \`upload/images.md\` æ–‡ä»¶
          2. æäº¤æ›´æ”¹è‡ªåŠ¨è§¦å‘åŒæ­¥
          3. æˆ–ä½¿ç”¨å·¥ä½œæµæ‰‹åŠ¨è§¦å‘
          
          ---
          *æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
          EOF
          
          echo "âœ… å·¥ä½œæµæ‘˜è¦å·²åˆ›å»º"