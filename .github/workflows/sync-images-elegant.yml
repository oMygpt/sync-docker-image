name: ä¼˜é›…çš„Dockeré•œåƒåŒæ­¥ç³»ç»Ÿ

on:
  # ä¿ç•™åŸæœ‰çš„æ–‡ä»¶è§¦å‘æ–¹å¼ä½œä¸ºå¤‡é€‰
  push:
    paths:
      - 'upload/images.md'
      - 'upload/batch_sync.json'
  
  # å¢å¼ºçš„æ‰‹åŠ¨è§¦å‘åŠŸèƒ½
  workflow_dispatch:
    inputs:
      sync_mode:
        description: 'åŒæ­¥æ¨¡å¼'
        required: true
        type: choice
        options:
          - 'single'     # å•ä¸ªé•œåƒ
          - 'multiple'   # å¤šä¸ªé•œåƒ
          - 'batch'      # æ‰¹é‡æ–‡ä»¶
          - 'preset'     # é¢„è®¾é•œåƒç»„
        default: 'single'
      
      single_image:
        description: 'å•ä¸ªé•œåƒåç§° (æ ¼å¼: nginx:latest)'
        required: false
        type: string
      
      multiple_images:
        description: 'å¤šä¸ªé•œåƒ (æ¯è¡Œä¸€ä¸ª)'
        required: false
        type: string
      
      preset_group:
        description: 'é¢„è®¾é•œåƒç»„'
        required: false
        type: choice
        options:
          - 'web-servers'    # WebæœåŠ¡å™¨ (nginx, apache, caddy)
          - 'databases'      # æ•°æ®åº“ (mysql, postgres, redis, mongodb)
          - 'ai-ml'          # AI/ML (pytorch, tensorflow, jupyter)
          - 'dev-tools'      # å¼€å‘å·¥å…· (node, python, golang)
          - 'monitoring'     # ç›‘æ§å·¥å…· (prometheus, grafana, jaeger)
        default: 'web-servers'
      
      target_registry:
        description: 'ç›®æ ‡ä»“åº“'
        required: false
        type: choice
        options:
          - 'aliyun-hangzhou'   # é˜¿é‡Œäº‘æ­å·
          - 'aliyun-beijing'    # é˜¿é‡Œäº‘åŒ—äº¬
          - 'aliyun-shanghai'   # é˜¿é‡Œäº‘ä¸Šæµ·
          - 'aliyun-shenzhen'   # é˜¿é‡Œäº‘æ·±åœ³
        default: 'aliyun-hangzhou'
      
      sync_options:
        description: 'åŒæ­¥é€‰é¡¹'
        required: false
        type: choice
        options:
          - 'normal'        # æ­£å¸¸åŒæ­¥
          - 'force'         # å¼ºåˆ¶åŒæ­¥
          - 'dry-run'       # å¹²è¿è¡Œ
          - 'verify-only'   # ä»…éªŒè¯
        default: 'normal'
      
      max_parallel:
        description: 'æœ€å¤§å¹¶å‘æ•° (1-10)'
        required: false
        type: number
        default: 3
        
      notification:
        description: 'é€šçŸ¥æ–¹å¼'
        required: false
        type: choice
        options:
          - 'none'          # æ— é€šçŸ¥
          - 'summary'       # æ‘˜è¦é€šçŸ¥
          - 'detailed'      # è¯¦ç»†é€šçŸ¥
        default: 'summary'
  
  # é€šè¿‡Issuesè§¦å‘åŒæ­¥
  issues:
    types: [opened, edited]
  
  # é€šè¿‡PRè§¦å‘åŒæ­¥
  pull_request:
    types: [opened, edited]
    paths:
      - 'sync-requests/**'

env:
  MAX_RETRIES: 3
  RETRY_DELAY: 10
  LOG_LEVEL: INFO

jobs:
  # è§£æè§¦å‘æºå’Œå‚æ•°
  parse-trigger:
    runs-on: ubuntu-latest
    outputs:
      trigger-type: ${{ steps.parse.outputs.trigger-type }}
      images-list: ${{ steps.parse.outputs.images-list }}
      sync-config: ${{ steps.parse.outputs.sync-config }}
      should-sync: ${{ steps.parse.outputs.should-sync }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Parse trigger source
        id: parse
        run: |
          echo "ğŸ” è§£æè§¦å‘æºå’Œå‚æ•°..."
          
          # åˆå§‹åŒ–å˜é‡
          TRIGGER_TYPE="unknown"
          IMAGES_LIST="[]"
          SYNC_CONFIG="{}"
          SHOULD_SYNC="false"
          
          # æ ¹æ®è§¦å‘äº‹ä»¶ç±»å‹å¤„ç†
          case "${{ github.event_name }}" in
            "workflow_dispatch")
              TRIGGER_TYPE="manual"
              SHOULD_SYNC="true"
              
              # è§£ææ‰‹åŠ¨è§¦å‘å‚æ•°
              SYNC_MODE="${{ github.event.inputs.sync_mode }}"
              echo "ğŸ“‹ åŒæ­¥æ¨¡å¼: $SYNC_MODE"
              
              case "$SYNC_MODE" in
                "single")
                  if [[ -n "${{ github.event.inputs.single_image }}" ]]; then
                    IMAGES_LIST='["${{ github.event.inputs.single_image }}"]'
                  fi
                  ;;
                "multiple")
                  if [[ -n "${{ github.event.inputs.multiple_images }}" ]]; then
                    # å°†å¤šè¡Œè¾“å…¥è½¬æ¢ä¸ºJSONæ•°ç»„
                    IMAGES_LIST=$(echo '${{ github.event.inputs.multiple_images }}' | jq -R -s 'split("\n") | map(select(length > 0 and test("^[^#]")))')
                  fi
                  ;;
                "preset")
                  # é¢„è®¾é•œåƒç»„
                  case "${{ github.event.inputs.preset_group }}" in
                    "web-servers")
                      IMAGES_LIST='["nginx:latest", "nginx:alpine", "httpd:latest", "caddy:latest"]'
                      ;;
                    "databases")
                      IMAGES_LIST='["mysql:8.0", "postgres:15", "redis:7-alpine", "mongo:6"]'
                      ;;
                    "ai-ml")
                      IMAGES_LIST='["pytorch/pytorch:latest", "tensorflow/tensorflow:latest", "jupyter/scipy-notebook:latest"]'
                      ;;
                    "dev-tools")
                      IMAGES_LIST='["node:18-alpine", "python:3.11-slim", "golang:1.21-alpine"]'
                      ;;
                    "monitoring")
                      IMAGES_LIST='["prom/prometheus:latest", "grafana/grafana:latest", "jaegertracing/all-in-one:latest"]'
                      ;;
                  esac
                  ;;
                "batch")
                  # ä»æ‰¹é‡æ–‡ä»¶è¯»å–
                  if [[ -f "upload/batch_sync.json" ]]; then
                    IMAGES_LIST=$(jq -c '.images // []' upload/batch_sync.json)
                  fi
                  ;;
              esac
              
              # æ„å»ºåŒæ­¥é…ç½®
              SYNC_CONFIG=$(jq -n \
                --arg target "${{ github.event.inputs.target_registry }}" \
                --arg options "${{ github.event.inputs.sync_options }}" \
                --argjson parallel "${{ github.event.inputs.max_parallel }}" \
                --arg notification "${{ github.event.inputs.notification }}" \
                '{
                  "target_registry": $target,
                  "sync_options": $options,
                  "max_parallel": $parallel,
                  "notification": $notification
                }')
              ;;
              
            "push")
              TRIGGER_TYPE="file_change"
              SHOULD_SYNC="true"
              
              # ä»æ–‡ä»¶è¯»å–é•œåƒåˆ—è¡¨
              if [[ -f "upload/images.md" ]]; then
                IMAGES_LIST=$(grep -v '^#' upload/images.md | grep -v '^$' | jq -R -s 'split("\n") | map(select(length > 0))')
              fi
              
              # é»˜è®¤é…ç½®
              SYNC_CONFIG='{
                "target_registry": "aliyun-hangzhou",
                "sync_options": "normal",
                "max_parallel": 3,
                "notification": "summary"
              }'
              ;;
              
            "issues")
              TRIGGER_TYPE="issue"
              
              # æ£€æŸ¥Issueæ ‡é¢˜æ˜¯å¦åŒ…å«åŒæ­¥å…³é”®è¯
              ISSUE_TITLE="${{ github.event.issue.title }}"
              if [[ "$ISSUE_TITLE" =~ ^\[sync\]|^\[åŒæ­¥\]|^sync:|^åŒæ­¥: ]]; then
                SHOULD_SYNC="true"
                
                # ä»Issueæ­£æ–‡è§£æé•œåƒåˆ—è¡¨
                ISSUE_BODY="${{ github.event.issue.body }}"
                # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„è§£æé€»è¾‘
                IMAGES_LIST='[]'  # ä¸´æ—¶è®¾ç½®ä¸ºç©ºæ•°ç»„
                
                SYNC_CONFIG='{
                  "target_registry": "aliyun-hangzhou",
                  "sync_options": "normal",
                  "max_parallel": 2,
                  "notification": "detailed"
                }'
              fi
              ;;
              
            "pull_request")
              TRIGGER_TYPE="pull_request"
              
              # æ£€æŸ¥PRæ˜¯å¦ä¿®æ”¹äº†åŒæ­¥è¯·æ±‚æ–‡ä»¶
              if [[ "${{ github.event.pull_request.title }}" =~ ^\[sync\]|^\[åŒæ­¥\] ]]; then
                SHOULD_SYNC="true"
                IMAGES_LIST='[]'  # ä»PRæ–‡ä»¶ä¸­è§£æ
                
                SYNC_CONFIG='{
                  "target_registry": "aliyun-hangzhou",
                  "sync_options": "dry-run",
                  "max_parallel": 2,
                  "notification": "detailed"
                }'
              fi
              ;;
          esac
          
          # è¾“å‡ºç»“æœ
          echo "trigger-type=$TRIGGER_TYPE" >> $GITHUB_OUTPUT
          echo "images-list=$IMAGES_LIST" >> $GITHUB_OUTPUT
          echo "sync-config=$SYNC_CONFIG" >> $GITHUB_OUTPUT
          echo "should-sync=$SHOULD_SYNC" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºè§£æç»“æœ
          echo "ğŸ“Š è§£æç»“æœ:"
          echo "  è§¦å‘ç±»å‹: $TRIGGER_TYPE"
          echo "  æ˜¯å¦åŒæ­¥: $SHOULD_SYNC"
          echo "  é•œåƒæ•°é‡: $(echo "$IMAGES_LIST" | jq 'length')"
          echo "  åŒæ­¥é…ç½®: $SYNC_CONFIG"

  # é¢„æ£€æŸ¥ä½œä¸š
  pre-check:
    needs: parse-trigger
    if: needs.parse-trigger.outputs.should-sync == 'true'
    runs-on: ubuntu-latest
    outputs:
      images-count: ${{ steps.validate.outputs.images-count }}
      config-valid: ${{ steps.validate.outputs.config-valid }}
      images-matrix: ${{ steps.validate.outputs.images-matrix }}
      target-registry: ${{ steps.validate.outputs.target-registry }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate and prepare
        id: validate
        run: |
          echo "ğŸ” éªŒè¯é…ç½®å’Œé•œåƒåˆ—è¡¨..."
          
          # è§£æé…ç½®
          SYNC_CONFIG='${{ needs.parse-trigger.outputs.sync-config }}'
          TARGET_REGISTRY=$(echo "$SYNC_CONFIG" | jq -r '.target_registry')
          SYNC_OPTIONS=$(echo "$SYNC_CONFIG" | jq -r '.sync_options')
          
          # æ˜ å°„ç›®æ ‡ä»“åº“
          case "$TARGET_REGISTRY" in
            "aliyun-hangzhou")
              REGISTRY_URL="registry.cn-hangzhou.aliyuncs.com"
              ;;
            "aliyun-beijing")
              REGISTRY_URL="registry.cn-beijing.aliyuncs.com"
              ;;
            "aliyun-shanghai")
              REGISTRY_URL="registry.cn-shanghai.aliyuncs.com"
              ;;
            "aliyun-shenzhen")
              REGISTRY_URL="registry.cn-shenzhen.aliyuncs.com"
              ;;
            *)
              REGISTRY_URL="registry.cn-hangzhou.aliyuncs.com"  # é»˜è®¤
              ;;
          esac
          
          # éªŒè¯å¿…éœ€çš„secrets
          required_secrets=("ALIYUN_USERNAME" "ALIYUN_PASSWORD" "ALIYUN_NAMESPACE")
          missing_secrets=()
          
          for secret in "${required_secrets[@]}"; do
            if [[ -z "${!secret:-}" ]]; then
              missing_secrets+=("$secret")
            fi
          done
          
          if [[ ${#missing_secrets[@]} -gt 0 ]]; then
            echo "âŒ ç¼ºå°‘å¿…éœ€çš„secrets: ${missing_secrets[*]}"
            echo "config-valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # å¤„ç†é•œåƒåˆ—è¡¨
          IMAGES_LIST='${{ needs.parse-trigger.outputs.images-list }}'
          IMAGES_COUNT=$(echo "$IMAGES_LIST" | jq 'length')
          
          if [[ $IMAGES_COUNT -eq 0 ]]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é•œåƒè¿›è¡ŒåŒæ­¥"
            echo "config-valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # éªŒè¯é•œåƒæ ¼å¼
          VALID_IMAGES=$(echo "$IMAGES_LIST" | jq -r '.[] | select(test("^[a-zA-Z0-9._/-]+(:([a-zA-Z0-9._-]+))?$"))')
          VALID_COUNT=$(echo "$VALID_IMAGES" | wc -l)
          
          if [[ $VALID_COUNT -ne $IMAGES_COUNT ]]; then
            echo "âš ï¸ å‘ç°æ— æ•ˆçš„é•œåƒæ ¼å¼ï¼Œå·²è¿‡æ»¤"
          fi
          
          # é‡æ–°æ„å»ºæœ‰æ•ˆé•œåƒåˆ—è¡¨
          MATRIX_JSON=$(echo "$VALID_IMAGES" | jq -R . | jq -s .)
          
          echo "âœ… é…ç½®éªŒè¯é€šè¿‡"
          echo "config-valid=true" >> $GITHUB_OUTPUT
          echo "images-count=$VALID_COUNT" >> $GITHUB_OUTPUT
          echo "images-matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "target-registry=$REGISTRY_URL" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºåŒæ­¥è®¡åˆ’
          echo "ğŸ“‹ åŒæ­¥è®¡åˆ’:"
          echo "  ç›®æ ‡ä»“åº“: $REGISTRY_URL"
          echo "  åŒæ­¥é€‰é¡¹: $SYNC_OPTIONS"
          echo "  é•œåƒæ•°é‡: $VALID_COUNT"
          echo "  é•œåƒåˆ—è¡¨:"
          echo "$VALID_IMAGES" | sed 's/^/    - /'
        env:
          ALIYUN_USERNAME: ${{ secrets.ALIYUN_USERNAME }}
          ALIYUN_PASSWORD: ${{ secrets.ALIYUN_PASSWORD }}
          ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}

  # ä¸»åŒæ­¥ä½œä¸š - å¤ç”¨ç°æœ‰çš„åŒæ­¥é€»è¾‘
  sync-images:
    needs: [parse-trigger, pre-check]
    if: needs.pre-check.outputs.config-valid == 'true'
    uses: ./.github/workflows/sync-images-enhanced.yml
    with:
      images-matrix: ${{ needs.pre-check.outputs.images-matrix }}
      target-registry: ${{ needs.pre-check.outputs.target-registry }}
      sync-config: ${{ needs.parse-trigger.outputs.sync-config }}
    secrets: inherit

  # é€šçŸ¥å’Œåé¦ˆ
  notify:
    needs: [parse-trigger, pre-check, sync-images]
    if: always() && needs.parse-trigger.outputs.should-sync == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Send notification
        run: |
          echo "ğŸ“¢ å‘é€åŒæ­¥ç»“æœé€šçŸ¥..."
          
          SYNC_CONFIG='${{ needs.parse-trigger.outputs.sync-config }}'
          NOTIFICATION_TYPE=$(echo "$SYNC_CONFIG" | jq -r '.notification')
          TRIGGER_TYPE="${{ needs.parse-trigger.outputs.trigger-type }}"
          
          # æ ¹æ®è§¦å‘ç±»å‹å’Œé€šçŸ¥è®¾ç½®å‘é€é€šçŸ¥
          case "$TRIGGER_TYPE" in
            "issue")
              # åœ¨Issueä¸­æ·»åŠ è¯„è®º
              echo "å°†åœ¨Issueä¸­æ·»åŠ åŒæ­¥ç»“æœè¯„è®º"
              ;;
            "pull_request")
              # åœ¨PRä¸­æ·»åŠ è¯„è®º
              echo "å°†åœ¨PRä¸­æ·»åŠ åŒæ­¥ç»“æœè¯„è®º"
              ;;
            *)
              # åˆ›å»ºå·¥ä½œæµæ‘˜è¦
              echo "åˆ›å»ºå·¥ä½œæµæ‘˜è¦"
              ;;
          esac
          
          # æ ¹æ®é€šçŸ¥ç±»å‹ç”Ÿæˆä¸åŒè¯¦ç»†ç¨‹åº¦çš„æŠ¥å‘Š
          case "$NOTIFICATION_TYPE" in
            "detailed")
              echo "ç”Ÿæˆè¯¦ç»†é€šçŸ¥æŠ¥å‘Š"
              ;;
            "summary")
              echo "ç”Ÿæˆæ‘˜è¦é€šçŸ¥æŠ¥å‘Š"
              ;;
            "none")
              echo "è·³è¿‡é€šçŸ¥"
              ;;
          esac
      
      - name: Update documentation
        run: |
          echo "ğŸ“š æ›´æ–°æ–‡æ¡£å’Œè®°å½•..."
          
          # æ›´æ–°åŒæ­¥å†å²
          SYNC_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          TRIGGER_TYPE="${{ needs.parse-trigger.outputs.trigger-type }}"
          IMAGES_COUNT="${{ needs.pre-check.outputs.images-count }}"
          
          # æ·»åŠ åˆ°å†å²è®°å½•
          echo "## $SYNC_TIME" >> sync_history.md
          echo "- **è§¦å‘æ–¹å¼**: $TRIGGER_TYPE" >> sync_history.md
          echo "- **é•œåƒæ•°é‡**: $IMAGES_COUNT" >> sync_history.md
          echo "- **è¿è¡ŒID**: ${{ github.run_id }}" >> sync_history.md
          echo "" >> sync_history.md
          
          # æäº¤æ›´æ”¹
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add sync_history.md || true
          
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ“ æ›´æ–°åŒæ­¥å†å²è®°å½• ($SYNC_TIME)"
            git push
          fi