name: Process and Push Docker Images

on:
  push:
    paths:
      - 'upload/images.md'

jobs:
  process-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v1
        with:
          registry: ${{ secrets.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      # 创建临时文件来存储镜像映射关系
      - name: Create temp directory
        run: mkdir -p temp done

      - name: Process new images
        run: |
          # 创建或清空临时映射文件
          echo "# Docker Image Mapping" > temp/image_mapping.md
          echo "| DockerHub Image | Aliyun Mirror |" >> temp/image_mapping.md
          echo "|-----------------|---------------|" >> temp/image_mapping.md
          
          # 如果存在现有的映射文件，先保存已有的映射关系
          if [ -f "image_list.md" ]; then
            tail -n +4 "image_list.md" > temp/existing_mappings.txt || true
          fi

          # 处理每个新镜像
          while IFS= read -r image || [[ -n "$image" ]]; do
            # 跳过空行和注释
            [[ -z "$image" || "${image:0:1}" == "#" ]] && continue
            
            # 清理行尾空格和回车符
            image=$(echo "$image" | tr -d '\r' | xargs)
            
            # 检查是否已经处理过这个镜像
            if [ ! -f "done/${image// /_}.txt" ]; then
              echo "Processing image: $image"
              
              # 拉取镜像
              if ! docker pull $image; then
                echo "Failed to pull image: $image"
                continue
              fi

              # 构造阿里云镜像地址
              aliyun_image="${{ secrets.ALIYUN_REGISTRY }}/${image#*/}"
              
              # 标记镜像
              if ! docker tag $image $aliyun_image; then
                echo "Failed to tag image: $image"
                continue
              fi

              # 推送镜像
              if ! docker push $aliyun_image; then
                echo "Failed to push image: $aliyun_image"
                continue
              fi

              # 添加到映射文件
              echo "| \`$image\` | \`$aliyun_image\` |" >> temp/image_mapping.md
              
              # 创建完成标记
              touch "done/${image// /_}.txt"
              echo "Successfully processed and pushed: $image"
            else
              echo "Image already processed: $image"
            fi
          done < upload/images.md

          # 合并现有映射和新映射
          if [ -f "temp/existing_mappings.txt" ]; then
            cat temp/existing_mappings.txt >> temp/image_mapping.md
          fi

          # 对映射表进行排序（排除前三行标题）
          (head -n 3 temp/image_mapping.md && tail -n +4 temp/image_mapping.md | sort -u) > image_list.md

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add done/ image_list.md
          git commit -m "Update image list and add processed markers" -a || echo "No changes to commit"
          git push
